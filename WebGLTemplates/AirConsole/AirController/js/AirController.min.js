var AirController=function(){this.fps=9,this.pages={},this.currentPage=null,this.timer=null,this.sender=null,this.enableHero=!1,this.orientation,this.vibrate,this.init=function(t,e,i){this.orientation=e,this.vibrate=i,this.findPages(),this.showPage(t),this.sender=new Sender,this.sender.init(this.orientation)},this.findPages=function(){t_pages=document.querySelectorAll("[air-page]");for(var t=0;t<t_pages.length;t++)this.addPage(t_pages[t].id)},this.sendData=function(t){if(null!=this.currentPage){var e=this.getInput();Object.keys(e).length>0&&(t?this.sender.sendNow(e):this.sender.setData(e))}},this.stop=function(){clearTimeout(this.timer)},this.getInput=function(){return this.currentPage.getInput()},this.addPage=function(t){var e=new Page(t,this);return this.pages[t]=e,document.getElementById(t).style.display="none",e},this.findPageButtons=function(t){t.findButtons(),t.findJoysticks()},this.getPage=function(t){return this.pages[t]},this.showPage=function(t){if(null!=this.currentPage){if(t==this.currentPage.elementId)return;this.currentPage.hide()}this.currentPage=this.pages[t],this.currentPage.isLoaded||(this.currentPage.isLoaded=!0,this.findPageButtons(this.currentPage)),this.pages[t].show()}},Page=function(t,e){this.elementId=t,this.input={},this.parent=e,this.isLoaded=!1,this.buttons={},this.joysticks={},this.findButtons=function(){for(var t=document.getElementById(this.elementId).querySelectorAll("[air-btn]"),e=0;e<t.length;e++)console.log(t[e].id),this.addButton(t[e].id,t[e].getAttribute("air-btn"),t[e].getAttribute("air-hero"))},this.addButton=function(t,e,i){i&&console.log("found hero button: "+t);var s=new Button(this,t,e,i);return this.buttons[t]=s,s},this.getButton=function(t){return this.buttons[t]},this.findJoysticks=function(){for(var t=document.getElementById(this.elementId).querySelectorAll("[air-joystick]"),e=0;e<t.length;e++)this.addJoystick(t[e].id,t[e].getAttribute("air-joystick"))},this.addJoystick=function(t,e){var i=new Joystick(this,t,e);return i.init(),this.joysticks[t]=i,i},this.getInput=function(){var t=this.input;for(var e in this.joysticks)if(this.joysticks[e].diff>5){var i=this.joysticks[e].input;this.joysticks[e].lastSend=this.joysticks[e].input;var s={type:"vector",value:{x:i.x,y:i.y}};t[this.joysticks[e].key]=s}return this.input={},t},this.register=function(){for(key in this.buttons)this.buttons[key].register();for(key in this.joysticks)this.joysticks[key].register()},this.unregister=function(){for(key in this.buttons)this.buttons[key].unregister();for(key in this.joysticks)this.joysticks[key].unregister()},this.show=function(){document.getElementById(this.elementId).style.display="block",this.register()},this.hide=function(){document.getElementById(this.elementId).style.display="none",this.unregister()},this.eventCallback=function(t,e){this.input[this.buttons[t].key]={type:"button",value:this.buttons[t].value},this.parent.sendData(!0)}},Button=function(t,e,i,s){this.elementId=e,this.eventType="click",this.page=t,this.key=i,this.value=0,this.callback=null,this.hero=s,this.bind=function(t){this.page=t},this.addCallback=function(t){return this.callback=t,this},this.register=function(){isEventSupported("touchstart")?this.eventType="touchstart":this.eventType="click";var t=this.key.split(":");t.length>1&&(this.key=t[0],this.value=t[1]),document.getElementById(this.elementId).addEventListener(this.eventType,this.eventHandler.bind(this),!1)},this.unregister=function(){document.getElementById(this.elementId).removeEventListener(this.eventType,this.eventHandler.bind(this))},this.eventHandler=function(t){if(console.log("hero: "+this.hero),"true"==this.hero&&0==controller.enableHero)return console.log("request hero"),void controller.sender.airconsole.getPremium();"vibrate"in navigator&&(navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate,AirController.vibrate&&window.navigator.vibrate(50)),this.page.eventCallback(this.elementId,t),null!=this.callback&&this.callback()}},Joystick=function(t,e,i){this.elementId=e,this.page=t,this.key=i,this.joytsick=null,this.input=new Victor(0,0),this.lastSend=new Victor(0,0),this.active=!1,this.diff=0,this.init=function(){this.joystick=new VirtualJoystick({container:document.getElementById(this.elementId),mouseSupport:!0,limitStickTravel:!0,stickRadius:50}),window.setInterval(function(t){return function(){t.run()}}(this),1/30*1e3)},this.register=function(){this.active=!0},this.unregister=function(){this.active=!1},this.run=function(){this.active&&(this.input=new Victor(this.joystick.deltaX(),this.joystick.deltaY()),this.diff=this.angleBetween(this.input,this.lastSend),(this.diff>45||this.diff<-45)&&controller.sendData(!0))},this.angleBetween=function(t,e){var i=180*(Math.atan2(e.y,e.x)-Math.atan2(t.y,t.x))/Math.PI;return i>180?i-=180*Math.ceil(i/180):i<-180&&(i+=180*Math.ceil(-1*i/180)),i<0&&(i*=-1),i}},Sender=function(){this.rtcFpsCap=12,this.rtcFps=8,this.fpsCap=9,this.fps=7,this.data={},this.lastData={},this.interval=0,this.lastSendTimestamp=0,this.sendImmediate=0,this.airconsole=null,this.webRtcTimeout=10,this.webRtcTimestamp=0,this.init=function(t){this.airconsole=new AirConsole({orientation:t}),this.airconsole.onDeviceStateChange=function(t,e){var i=!0;try{e.custom}catch(t){i=!1}if(i&&void 0!==e.custom&&null!==e.custom)try{var s=JSON.parse(e.custom);s[this.device_id]&&(controller.enableHero=s[this.device_id].enablehero,controller.showPage(s[this.device_id].view),document.body.className="P"+(s[this.device_id].playerId+1)+" "+s[this.device_id].class+" "+s[this.device_id].color)}catch(t){console.log("Error handle here!"),console.error("parsing data: "+e.custom),console.error(t)}else;},this.interval=1/this.fps*1050,Date.now||(Date.now=function(){return(new Date).getTime()}),this.lastSendTimestamp=Date.now(),this.webRtcTimestamp=Date.now(),window.setInterval(function(t){return function(){t.run()}}(this),1/60*1e3)},this.run=function(){var t=Date.now();t-this.lastSendTimestamp>this.interval&&this.send(),t-this.webRtcTimestamp>2e3&&this.webRtcTimeout>0&&(this.webRtcTimeout--,this.webRtcTimestamp=Date.now(),null!=this.airconsole.devices[this.airconsole.getDeviceId()]&&2==this.airconsole.devices[this.airconsole.getDeviceId()].rtc?(console.log("Using webRTC"),this.webRtcTimeout=0,this.fpsCap=this.rtcFpsCap,this.fps=this.rtcFps,this.interval=1/this.fps*1050):console.log("no webRTC: "+this.webRtcTimeout))},this.setData=function(t){for(var e in t)this.data[e]=t[e]},this.send=function(){this.lastSendTimestamp=Date.now(),Object.keys(this.data).length>0&&(this.airconsole.message(0,this.data),console.log(this.data),this.lastData=this.data,this.data={})},this.sendNow=function(t){this.setData(t),this.sendImmediate+this.fps<this.fpsCap&&(this.sendImmediate++,window.setInterval(function(t){return function(){t.deque()}}(this),1e3),this.send())},this.deque=function(){this.sendImmediate--}},isEventSupported=function(){var t={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return function(e){var i=document.createElement(t[e]||"div"),s=(e="on"+e)in i;return s||(i.setAttribute(e,"return;"),s="function"==typeof i[e]),i=null,s}}();